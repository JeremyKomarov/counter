name: Deploy Production

on:
    push:
        branches:
            - main

jobs:
    deploy-prod:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout main
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18

            - name: Install dependencies
              run: npm ci

            - name: Build project
              run: npm run build

            - name: Check deploy permissions
              run: |
                  if [ "${GITHUB_ACTOR}" != "JeremyKomarov" ]; then
                    echo "âŒ Only JeremyKomarov can deploy production"
                    exit 1
                  fi

            - name: Deploy to Prod
              run: |
                  echo "${{ secrets.PROD_SSH_KEY }}" > key.pem
                  chmod 600 key.pem
                  rsync -avz --delete -e "ssh -i key.pem -o StrictHostKeyChecking=no" \
                    dist/ ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:/var/www/app/dist/
